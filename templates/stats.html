
{% extends "base.html" %}
{% block title %}Estadísticas · PIPS{% endblock %}
{% block content %}
  <div class="card">
    <h1>Estadísticas</h1>    
    <div class="charts">
      {% for d in difficulties %}
        <div class="chart-block">
          <h2>{{ d }}</h2>
          <canvas id="chart_{{ d }}"></canvas>
        </div>
      {% endfor %}
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const dataByDiff = {{ data_by_diff|tojson }};

    function pad(n){ return (n<10?'0':'') + n; }
    function secondsToMMSS(s) {
      if (s === null || s === undefined) return null;
      const m = Math.floor(s / 60);
      const sec = s % 60;
      return `${pad(m)}:${pad(sec)}`;
    }
    // Deterministic color from string (HSL)
    const palette = [
      "#1f77b4", // azul
      "#ff7f0e", // naranja
      "#2ca02c", // verde
      "#d62728", // rojo
      "#9467bd", // morado
      "#8c564b", // marrón
      "#e377c2", // rosa
      "#7f7f7f", // gris
      "#bcbd22", // amarillo oliva
      "#17becf", // cian
    ];

    function getColor(index) {
      return palette[index % palette.length];
    }


    function buildChart(canvasId, payload) {
      const ctx = document.getElementById(canvasId);
      const labels = payload.labels;
      const datasets = payload.datasets.map((ds, i) => ({
        label: ds.label,
        data: ds.data,
        spanGaps: false,
        borderColor: ds.borderColor || getColor(i),
        backgroundColor: ds.backgroundColor || getColor(i),
        borderDash: ds.borderDash || [],
        tension: ds.tension !== undefined ? ds.tension : 0.25,
        pointRadius: ds.pointRadius !== undefined ? ds.pointRadius : 3,
      }));

      new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              min: 0,
              ticks: {
                callback: function(value, index, ticks) {
                  return secondsToMMSS(value);
                }
              },
              title: { display: true, text: "Tiempo" }
            },
            x: {
              title: { display: true, text: "Fecha" }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(ctx) {
                  const v = ctx.parsed.y;
                  return `${ctx.dataset.label}: ${secondsToMMSS(v)}`;
                }
              }
            },
            legend: {
              position: 'bottom'
            }
          },
          elements: {
            line: { borderWidth: 2 },
          }
        }
      });
    }

    for (const diff of Object.keys(dataByDiff)) {
      buildChart(`chart_${diff}`, dataByDiff[diff]);
    }
  </script>
{% endblock %}
